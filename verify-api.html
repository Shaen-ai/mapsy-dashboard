<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify API Configuration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Mapsy Dashboard - API Configuration Verifier</h1>

    <div id="status"></div>

    <h2>Actions:</h2>
    <button onclick="checkCurrentBuild()">Check Current Build</button>
    <button onclick="clearCache()">Clear Cache & Reload</button>
    <button onclick="testAPI()">Test API Endpoints</button>

    <h2>Results:</h2>
    <div id="results"></div>

    <script>
        const API_URL = 'https://mapsy-api.nextechspires.com/api';

        function addStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            status.appendChild(div);
        }

        function addResult(title, content) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            results.appendChild(div);
        }

        async function checkCurrentBuild() {
            addStatus('Checking current build configuration...', 'info');

            try {
                // Check if React app is loaded
                if (window.REACT_APP_API_URL) {
                    addStatus(`Environment Variable: ${window.REACT_APP_API_URL}`, 'success');
                } else {
                    addStatus('Environment variable not found in window', 'error');
                }

                // Try to fetch the build files
                const response = await fetch('/static/js/main.616d2159.js');
                const text = await response.text();

                if (text.includes('https://mapsy-api.nextechspires.com/api')) {
                    addStatus('✅ Production API URL found in build!', 'success');
                } else if (text.includes('localhost:8000')) {
                    addStatus('❌ Localhost URL still in build!', 'error');
                } else {
                    addStatus('⚠️ Could not determine API URL in build', 'info');
                }
            } catch (error) {
                addStatus(`Error checking build: ${error.message}`, 'error');
            }
        }

        function clearCache() {
            addStatus('Clearing cache...', 'info');

            // Clear localStorage
            localStorage.clear();

            // Clear sessionStorage
            sessionStorage.clear();

            // Try to clear service worker cache if exists
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                });
            }

            addStatus('Cache cleared! Reloading in 2 seconds...', 'success');

            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }

        async function testAPI() {
            addStatus('Testing API endpoints...', 'info');

            // Test locations endpoint
            try {
                const locResponse = await fetch(`${API_URL}/locations`);
                if (locResponse.ok) {
                    const locations = await locResponse.json();
                    addStatus(`✅ /api/locations - OK (${locations.length} locations found)`, 'success');
                    addResult('Locations Response (first item):', JSON.stringify(locations[0], null, 2));
                } else {
                    addStatus(`❌ /api/locations - Failed (${locResponse.status})`, 'error');
                }
            } catch (error) {
                addStatus(`❌ /api/locations - Error: ${error.message}`, 'error');
            }

            // Test widget-config endpoint
            try {
                const configResponse = await fetch(`${API_URL}/widget-config`);
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    addStatus('✅ /api/widget-config - OK', 'success');
                    addResult('Widget Config Response:', JSON.stringify(config, null, 2));
                } else {
                    addStatus(`❌ /api/widget-config - Failed (${configResponse.status})`, 'error');
                }
            } catch (error) {
                addStatus(`❌ /api/widget-config - Error: ${error.message}`, 'error');
            }
        }

        // Check on load
        window.addEventListener('load', () => {
            addStatus('Page loaded. Use the buttons above to verify API configuration.', 'info');

            // Show current URL being used
            addStatus(`Expected API URL: ${API_URL}`, 'info');
        });
    </script>
</body>
</html>